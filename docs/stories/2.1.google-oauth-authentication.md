# Story 2.1: Google OAuth Authentication Flow

## Status
Draft

## Story
**As a** user,
**I want** to sign in with my Google account to access YouTube data,
**so that** the app can retrieve my subscriptions, playlists, and viewing history.

## Acceptance Criteria
1. OAuth 2.0 flow implemented using `ASWebAuthenticationSession` (native macOS authentication UI)
2. OAuth scopes requested: `https://www.googleapis.com/auth/youtube.readonly` (minimal scope)
3. OAuth credentials (client ID, client secret) stored securely (not hardcoded, loaded from config file excluded from repo)
4. Authorization code exchange implemented to obtain access token and refresh token
5. Tokens stored securely in macOS Keychain with appropriate access controls
6. User shown clear explanation of what data the app will access before OAuth redirect
7. OAuth flow cancellable by user without app crash
8. Success/failure states handled gracefully with user-friendly error messages

## Tasks / Subtasks
- [ ] Create OAuth handler service (AC: 1, 2, 3, 4)
  - [ ] Create `MyToob/Features/YouTube/OAuth2Handler.swift`
  - [ ] Import ASWebAuthenticationSession
  - [ ] Configure OAuth authorization URL
  - [ ] Configure OAuth token URL
  - [ ] Implement authorization request method
  - [ ] Implement authorization code exchange
- [ ] Configure OAuth scopes and endpoints (AC: 1, 2)
  - [ ] Set authorization URL: `https://accounts.google.com/o/oauth2/v2/auth`
  - [ ] Set token URL: `https://oauth2.googleapis.com/token`
  - [ ] Request scope: `https://www.googleapis.com/auth/youtube.readonly`
  - [ ] Configure redirect URI for macOS app
- [ ] Secure credential management (AC: 3)
  - [ ] Create Configuration enum to load OAuth credentials
  - [ ] Load client ID from environment or .env file
  - [ ] Load client secret from environment or .env file
  - [ ] Add .env to .gitignore
  - [ ] Create .env.example with placeholder values
  - [ ] Document credential setup in README
- [ ] Implement token exchange (AC: 4)
  - [ ] Build token request with authorization code
  - [ ] Include client ID and secret in request
  - [ ] Parse token response (access token, refresh token, expires_in)
  - [ ] Handle token exchange errors
- [ ] Implement Keychain storage (AC: 5)
  - [ ] Use KeychainService wrapper (from Story 1.1)
  - [ ] Store access token with `kSecAttrAccessibleWhenUnlocked`
  - [ ] Store refresh token with `kSecAttrAccessibleWhenUnlocked`
  - [ ] Store token expiry time
  - [ ] Implement token retrieval methods
- [ ] Create pre-authorization consent UI (AC: 6)
  - [ ] Create consent view explaining data access
  - [ ] Show what scopes are being requested
  - [ ] Explain "YouTube Data (Read-Only)" permission
  - [ ] Provide "Cancel" and "Continue" buttons
  - [ ] Only start OAuth flow after user confirms
- [ ] Handle user cancellation (AC: 7)
  - [ ] Catch ASWebAuthenticationSession cancellation
  - [ ] Return to previous state without crash
  - [ ] Log cancellation event (privacy: public)
  - [ ] Clear any partial state
- [ ] Implement error handling (AC: 8)
  - [ ] Handle network errors
  - [ ] Handle invalid credentials
  - [ ] Handle user denial at Google OAuth consent screen
  - [ ] Handle malformed responses
  - [ ] Show user-friendly error messages
  - [ ] Log errors for debugging

## Dev Notes

### OAuth Integration Requirements
[Source: architecture/external-apis.md]

**Google OAuth 2.0 Configuration:**
- **Authorization URL:** `https://accounts.google.com/o/oauth2/v2/auth`
- **Token URL:** `https://oauth2.googleapis.com/token`
- **Scopes:** `https://www.googleapis.com/auth/youtube.readonly`
- **Native Flow:** ASWebAuthenticationSession for macOS
- **Token Storage:** Keychain (access token expires ~3600s, refresh token long-lived)
- **Auto-refresh:** When access token expired (5-minute buffer)

### Security Requirements
[Source: architecture/security-and-performance.md]

**OAuth Token Security:**
- Stored in Keychain with `kSecAttrAccessibleWhenUnlocked` attribute
- Never hardcode client ID/secret in source code
- Load credentials from environment variables or secure config file
- Exclude config file from version control (.gitignore)

**Data Security:**
- TLS 1.3 enforced for all OAuth communication
- Input validation on all OAuth responses
- No credentials in crash logs or diagnostics exports

### Tech Stack
[Source: architecture/tech-stack.md]
- **OAuth:** ASWebAuthenticationSession (native macOS authentication UI)
- **Security:** Keychain Services (hardware-backed encryption, sandbox-compliant)
- **Networking:** URLSession with async/await

### Coding Standards
[Source: architecture/coding-standards.md]
- **CRITICAL:** Never call `SecItemAdd` directly (use `KeychainService` wrapper)
- **CRITICAL:** Access via `Configuration` enum, never `ProcessInfo.processInfo.environment` directly
- All network calls must use async/await
- All throwing functions wrapped in do-catch

### File Locations
[Source: architecture/unified-project-structure.md]
- OAuth handler: `MyToob/Features/YouTube/OAuth2Handler.swift`
- Keychain service: `MyToob/Core/Security/KeychainService.swift` (from Story 1.1)
- Configuration: `MyToob/Core/Utilities/Configuration.swift`

### Implementation Pattern
```swift
import AuthenticationServices

final class OAuth2Handler {
    private let authURL = URL(string: "https://accounts.google.com/o/oauth2/v2/auth")!
    private let tokenURL = URL(string: "https://oauth2.googleapis.com/token")!
    private let scope = "https://www.googleapis.com/auth/youtube.readonly"

    private var clientID: String {
        Configuration.googleOAuthClientID
    }

    private var clientSecret: String {
        Configuration.googleOAuthClientSecret
    }

    func authenticate() async throws -> (accessToken: String, refreshToken: String) {
        // Implementation here
    }
}
```

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
- **Test Location:** `MyToobTests/Services/`
- **Test Framework:** XCTest with async/await support
- **Coverage Target:** 80% for services

### Testing Requirements for This Story
**Unit Tests:**
- Create `MyToobTests/Services/OAuth2HandlerTests.swift`
- Test: OAuth URL construction with correct parameters
- Test: Authorization code exchange with mocked token endpoint
- Test: Token response parsing
- Test: Keychain storage and retrieval
- Test: Error handling for various failure scenarios
- Test: User cancellation handling

**Integration Tests:**
- Test: Full OAuth flow with mocked ASWebAuthenticationSession
- Test: Keychain persistence across app restarts
- Test: Error recovery scenarios

**Manual Testing:**
1. Run app and initiate OAuth flow
2. Verify ASWebAuthenticationSession presents
3. Verify redirect to Google OAuth consent screen
4. Grant permission and verify redirect back
5. Verify tokens stored in Keychain
6. Cancel flow and verify no crash
7. Test with invalid credentials
8. Test with network disconnected

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-17 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

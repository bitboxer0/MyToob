# Story 2.4: ETag-Based Caching for Metadata

## Status
Draft

## Story
**As a** developer,
**I want** ETag-based caching with If-None-Match headers to minimize API quota usage,
**so that** repeated requests for the same data don't consume quota unnecessarily.

## Acceptance Criteria
1. Caching layer stores API responses keyed by request URL + parameters
2. When response includes `ETag` header, cache stores both ETag and response body
3. On subsequent requests, include `If-None-Match: <cached-ETag>` header
4. If server returns `304 Not Modified`, use cached response body (no quota charge)
5. If server returns `200 OK` with new data, update cache with new ETag and body
6. Cache eviction policy: LRU with 1000-item limit or 7-day TTL, whichever comes first
7. Cache hit rate logged for performance monitoring (goal: >90% hit rate on repeated refreshes)

## Tasks / Subtasks
- [ ] Create caching layer (AC: 1, 2)
  - [ ] Create `MyToob/Core/Networking/CachingLayer.swift`
  - [ ] Implement cache key generation
  - [ ] Store ETag + response body pairs
  - [ ] Use in-memory cache with persistence option
- [ ] Implement If-None-Match header (AC: 3)
  - [ ] Check cache for existing ETag
  - [ ] Add If-None-Match header to requests
  - [ ] Send conditional request
- [ ] Handle 304 responses (AC: 4)
  - [ ] Detect 304 status code
  - [ ] Return cached response body
  - [ ] Log cache hit
  - [ ] Don't increment quota counter
- [ ] Handle 200 responses (AC: 5)
  - [ ] Extract new ETag from response
  - [ ] Store new response body
  - [ ] Update cache entry
  - [ ] Log cache miss
- [ ] Implement LRU eviction (AC: 6)
  - [ ] Track access times
  - [ ] Enforce 1000-item limit
  - [ ] Enforce 7-day TTL
  - [ ] Evict oldest entries
- [ ] Add cache monitoring (AC: 7)
  - [ ] Track hit rate
  - [ ] Log cache statistics
  - [ ] Target >90% hit rate

## Dev Notes
[Source: architecture/external-apis.md, architecture/security-and-performance.md]
- ETag caching minimizes quota consumption
- Goal: 95%+ hit rate on repeated refreshes
- LRU eviction: 1000 items or 7 days
- File: `MyToob/Core/Networking/CachingLayer.swift`

## Testing
[Source: architecture/testing-strategy.md]
- Test cache hit/miss scenarios
- Test ETag extraction and storage
- Test 304 vs 200 handling
- Test LRU eviction

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-17 | 1.0 | Initial story creation | Scrum Master (Bob) |

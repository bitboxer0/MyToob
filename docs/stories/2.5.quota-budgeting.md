# Story 2.5: API Quota Budgeting & Circuit Breaker

## Status
Draft

## Story
**As a** developer,
**I want** per-endpoint quota budgeting with circuit breaker pattern on 429 errors,
**so that** the app doesn't exhaust the user's daily API quota.

## Acceptance Criteria
1. Quota cost table defined for each endpoint: `search.list` = 100 units, `videos.list` = 1 unit, etc.
2. Quota budget tracker increments consumed units per request (reset daily at midnight PT)
3. Before each request, check if budget would exceed daily limit (10,000 units default)
4. If quota would be exceeded, return cached data or show user warning
5. On 429 response, implement exponential backoff: retry after 1s, 2s, 4s, 8s (max 3 retries)
6. Circuit breaker opens after 5 consecutive 429s (blocks further requests for 1 hour)
7. Dev-only quota dashboard shows real-time unit consumption per endpoint

## Tasks / Subtasks
- [ ] Create quota tracker (AC: 1, 2, 3)
  - [ ] Create `MyToob/Features/YouTube/QuotaBudgetTracker.swift`
  - [ ] Define quota costs per endpoint
  - [ ] Track daily consumption
  - [ ] Reset at midnight PT
  - [ ] Check before requests
- [ ] Implement quota checking (AC: 4)
  - [ ] Calculate request cost
  - [ ] Check against remaining quota
  - [ ] Return cached data if over quota
  - [ ] Show user warning
- [ ] Implement exponential backoff (AC: 5)
  - [ ] Detect 429 responses
  - [ ] Retry with 1s, 2s, 4s, 8s delays
  - [ ] Max 3 retries
  - [ ] Log retry attempts
- [ ] Implement circuit breaker (AC: 6)
  - [ ] Track consecutive 429s
  - [ ] Open circuit after 5 failures
  - [ ] Block requests for 1 hour
  - [ ] Auto-reset after timeout
- [ ] Create quota dashboard (AC: 7)
  - [ ] Show current consumption
  - [ ] Show quota per endpoint
  - [ ] Only in Debug builds

## Dev Notes
[Source: architecture/external-apis.md, architecture/coding-standards.md]
- Daily quota: 10,000 units (default)
- search.list: 100 units, videos.list: 1 unit
- Circuit breaker: 5 consecutive 429s â†’ 1hr block
- CRITICAL: Always check quota budget before request
- File: `MyToob/Features/YouTube/QuotaBudgetTracker.swift`

## Testing
[Source: architecture/testing-strategy.md]
- Test quota tracking and reset
- Test exponential backoff
- Test circuit breaker logic
- Mock 429 responses

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-17 | 1.0 | Initial story creation | Scrum Master (Bob) |

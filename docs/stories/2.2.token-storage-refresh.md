# Story 2.2: Token Storage & Automatic Refresh

## Status
Draft

## Story
**As a** developer,
**I want** OAuth tokens securely stored in Keychain with automatic refresh when expired,
**so that** users remain authenticated without repeated sign-ins.

## Acceptance Criteria
1. Keychain wrapper created for storing/retrieving access token and refresh token
2. Token expiry time tracked (typically 3600 seconds for access token)
3. Before each API call, check if access token is expired (within 5-minute buffer)
4. If expired, automatically refresh using refresh token via OAuth token endpoint
5. If refresh fails (invalid refresh token), prompt user to re-authenticate
6. "Sign Out" action in Settings clears all tokens from Keychain
7. Unit tests verify token refresh logic with mocked OAuth endpoints

## Tasks / Subtasks
- [ ] Create KeychainService wrapper (AC: 1)
  - [ ] Create `MyToob/Core/Security/KeychainService.swift`
  - [ ] Implement save method for tokens
  - [ ] Implement retrieve method for tokens
  - [ ] Implement delete method for sign out
  - [ ] Use `kSecAttrAccessibleWhenUnlocked` attribute
- [ ] Implement token expiry tracking (AC: 2, 3)
  - [ ] Store token expiry timestamp in UserDefaults
  - [ ] Calculate expiry from `expires_in` response field
  - [ ] Create method to check if token expired (5-min buffer)
  - [ ] Return isExpired boolean
- [ ] Implement automatic token refresh (AC: 4)
  - [ ] Create refresh method in OAuth2Handler
  - [ ] Build refresh request with refresh token
  - [ ] Call OAuth token endpoint
  - [ ] Parse new access token and expiry
  - [ ] Update Keychain with new access token
  - [ ] Update expiry timestamp
- [ ] Handle refresh failures (AC: 5)
  - [ ] Catch invalid_grant errors
  - [ ] Clear tokens from Keychain on failure
  - [ ] Trigger re-authentication flow
  - [ ] Show user notification about re-auth needed
- [ ] Implement sign out (AC: 6)
  - [ ] Add Sign Out button in Settings
  - [ ] Clear access token from Keychain
  - [ ] Clear refresh token from Keychain
  - [ ] Clear expiry timestamp
  - [ ] Reset authentication state
- [ ] Create unit tests (AC: 7)
  - [ ] Test token storage and retrieval
  - [ ] Test expiry checking logic
  - [ ] Test refresh with mocked endpoint
  - [ ] Test refresh failure handling
  - [ ] Test sign out clears all data

## Dev Notes
[Source: architecture/external-apis.md, architecture/security-and-performance.md]
- Token storage: Keychain with `kSecAttrAccessibleWhenUnlocked`
- Access token lifetime: ~3600 seconds (1 hour)
- Refresh before expiry: 5-minute buffer
- Refresh token: Long-lived, stored securely
- Auto-refresh: Check before each API call
- File location: `MyToob/Core/Security/KeychainService.swift`

## Testing
[Source: architecture/testing-strategy.md]
- Test file: `MyToobTests/KeychainServiceTests.swift`
- Unit tests: Storage, retrieval, expiry logic, refresh flow
- Integration tests: Full token lifecycle
- Mock OAuth endpoints for testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-17 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
